<!doctype html><html lang=zh-cn style=transform:none><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover"><title>韩西瓜的电台 | 我要喝啤酒啊</title><meta name=robots content="noindex,follow"><meta name=msapplication-TileImage content="https://hanyu.cool/home/static/img/favicon.ico"><link rel=dns-prefetch href=https://s.w.org/><link rel=stylesheet id=smartideo_css-css href=https://file.hanyu.cool/site/life/static/v1/css/smartideo.css type=text/css media=screen><link rel=stylesheet id=jimu-css-css href=https://file.hanyu.cool/site/life/static/v1/css/jimu.css type=text/css media=all><link rel=stylesheet id=jimu-gutenberg-css-css href=https://file.hanyu.cool/site/life/static/v1/css/gutenberg-custom.css type=text/css media=all><link rel=stylesheet id=iconfont-css href=https://file.hanyu.cool/site/life/static/v1/css/iconfont.css type=text/css media=all><link rel=stylesheet id=nicetheme-css href=https://file.hanyu.cool/site/life/static/v1/css/h.css type=text/css media=all><link rel=stylesheet id=style-css href=https://file.hanyu.cool/site/life/static/v1/css/style.css type=text/css media=all><link rel=stylesheet id=HighlightCss-css href=https://file.hanyu.cool/site/life/static/v1/css/a11y-dark.css type=text/css media=all><link rel=stylesheet id=LightgalleryCss-css href=https://file.hanyu.cool/site/life/static/v1/css/lightgallery.min.css type=text/css media=all><style type=text/css>.hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0;border:none}.hljs-ln-n:before{content:attr(data-line-number)}</style><style id=theia-sticky-sidebar-stylesheet-TSS>.theiaStickySidebar:after{content:"";display:table;clear:both}</style><script src=https://cdn.bootcdn.net/ajax/libs/jquery/1.12.4/jquery.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/jquery-migrate/1.4.1/jquery-migrate.min.js></script>
<link rel=icon href=https://hanyu.cool/home/static/img/favicon.ico sizes=32x32><link rel=icon href=https://hanyu.cool/home/static/img/favicon.ico sizes=192x192><link rel=apple-touch-icon href=https://hanyu.cool/home/static/img/favicon.ico><link href=https://hanyu.cool/home/static/img/favicon.ico rel=apple-touch-icon><link href=https://hanyu.cool/home/static/img/favicon.ico rel=apple-touch-icon sizes=76x76><link href=https://hanyu.cool/home/static/img/favicon.ico rel=apple-touch-icon sizes=120x120><link href=https://hanyu.cool/home/static/img/favicon.ico rel=apple-touch-icon sizes=152x152><link rel="shortcut icon" href=https://hanyu.cool/home/static/img/favicon.ico></head><body class="post-template-default single single-post postid-4575 single-format-image wp-embed-responsive nice-style-radius nice-style-shadow"><header class=header><nav class="navbar navbar-expand-md fixed-top"><div class=container><a href=/lifeblog rel=home class="navbar-brand m-0 order-1"><img class="logo loaded" src=http://file.hanyu.cool/site/life/static/v1/img/logo.png alt=韩西瓜的电台 data-src=http://file.hanyu.cool/site/life/static/v1/img/logo.png data-nclazyload=true data-was-processed=true style=border-radius:8px>
<img class=logo-night src=http://file.hanyu.cool/site/life/static/v1/img/logo.png alt=韩西瓜的电台 data-src=http://file.hanyu.cool/site/life/static/v1/img/logo.png data-nclazyload=true style=border-radius:8px></a><ul class="nav main-submenu align-items-center flex-row flex-shrink-0 order-2 order-md-3"><li class="nav-item d-none d-lg-inline-block"><a href=javascript: class="nice-tooltip-hide switch-dark-mode nav-link text-lg" data-toggle=nicetooltip data-placement=bottom title data-original-title=夜晚模式><i class="night iconfont icon-moon_circle"></i><i class="light text-warning iconfont icon-moon_circle_fill"></i></a></li><li class="nav-item d-lg-none"><a id=mobile-sidebar-trigger class="nav-link text-lg"><i class="d-block iconfont icon-menu"></i></a></li></ul><div class="collapse navbar-collapse show navbar-scroll order-3 order-md-2 mx-md-4"><ul class="navbar-nav main-menu d-none d-lg-flex mr-auto px-4"><li id=menu-item-4885 class="current-menu-item menu-item menu-item-type-custom menu-item-object-custom current-menu-ancestor current-menu-parent menu-item-4885"><a href=/lifeblog>首页</a></li><li id=menu-item-4884 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-4884"><a><span class="sub-menu-icon text-xs iconfont icon-caret-down"></span>社交</a><ul class=sub-menu><li id=menu-item-4909 class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4909"><a href=https://hanyu.cool/wechat/ target=_blank>公众号™</a></li><li id=menu-item-4909 class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4909"><a href=https://weibo.com/sohanyu target=_blank>微博</a></li><li id=menu-item-4909 class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4909"><a href="javascript: alert('Sorry ~ Building')">播客</a></li></ul></li><li id=menu-item-4884 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-4884"><a><span class="sub-menu-icon text-xs iconfont icon-caret-down"></span>关于</a><ul class=sub-menu><li id=menu-item-4919 class="menu-item menu-item-type-post_type menu-item-object-post menu-item-4919"><a href=https://hanyu.cool/about/>我</a></ul></li></ul></div></div></nav></header><div id=content><div class="post-image-poster bg-dark pt-5 pb-4 py-md-4 py-xl-5"><div class="bg-effect bg-image-color" style="background:linear-gradient(to top,#221f19 10%,#b78463 200%)"></div><div class="bg-effect bg-poster bg-image-cover" data-img style='background-image:url("")'></div><div class=container><div class="post-header text-center pt-4 pt-md-5"><h1 class="h3 mt-4 mt-md-5">我是大banner</h1><div class="post-meta d-flex align-items-center justify-content-center text-sm text-muted mt-3 mt-md-3"><div class="author-name author-popup">韩西瓜</div><time class="date mx-2 mx-md-2">Tuesday, March 23, 2021</time>
<span class="d-none d-md-inline-block mx-md-2"><i>发布在</i>
<a href=https://hanyu.cool/lifeblog/categories/%E6%8A%80%E6%9C%AF/ rel="category tag" target=_blank>「技术」</a></span></div></div><div class="media media-21x9 rounded mt-3 mt-md-4"><div class="media-content poster-zoom" style=background-image:url(https://okhanyu.oss-cn-beijing.aliyuncs.com/hysite/hysite-fun/artice/image/test/1.jpg) data-bg=" url(https://okhanyu.oss-cn-beijing.aliyuncs.com/hysite/hysite-fun/artice/image/test/1.jpg)" data-nclazyload=true data-was-processed=true></div></div></div></div><main class="py-3 py-md-4 py-lg-5"><div class=container><div class="row justify-content-lg-center"><div class="col-12 col-lg-10"><div class=post><div class=post-content><div class=nc-light-gallery><blockquote><p>辛苦移步微信公众号点赞、在看、关注：
<a href=https://mp.weixin.qq.com/s/82S1AbBeJzYuGhl6FvjQcg>分布式锁 | 电商防超卖的N+1个坑！</a></p></blockquote><p>大家好，我是西瓜。<br>今天和同事讨论库存防超卖问题，发现虽然只是简单的库存扣减场景，却隐藏着很多坑，一不小心就容易翻车，让西瓜推土机来填平这些坑。</p><h2 id=单实例环境>单实例环境</h2><p>一般电商体系防止库存超卖，主要有以下几种方式：
<img src=http://file-ok.hanyu.cool/hysite/hysite-tech/article/image/2021-03-23/oversold.png alt=导图>
防止库存超卖，最先想到的可能就是「锁」，如果是一些单实例部署的库存服务，大部分情况下我们可以使用以下锁或并发工具类：
<img src=http://file-ok.hanyu.cool/hysite/hysite-tech/article/image/2021-03-23/java_lock.png alt=单机锁>
这三个任何一个都可以保证同一单位时间只有一个线程能够进行库存扣减，废话不多说，上码！</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 库存扣减（伪代码 ReentrantLock )
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param stockRequestDTO
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Boolean
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Boolean <span style=color:#a6e22e>stockHandle</span><span style=color:#f92672>(</span>StockRequestDTO stockRequestDTO<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 日志打印...校验...前置处理等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> stock <span style=color:#f92672>=</span> stockMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>getStock</span><span style=color:#f92672>(</span>stockRequestDTO<span style=color:#f92672>.</span><span style=color:#a6e22e>getGoodsId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        reentrantLock<span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> result <span style=color:#f92672>=</span> stock <span style=color:#f92672>&gt;</span> 0 <span style=color:#f92672>?</span> 
</span></span><span style=display:flex><span>                    stockMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>updateStock</span><span style=color:#f92672>(</span>stockRequestDTO<span style=color:#f92672>.</span><span style=color:#a6e22e>getGoodsId</span><span style=color:#f92672>(),</span> <span style=color:#f92672>--</span>stock<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> result <span style=color:#f92672>&gt;</span> 0 <span style=color:#f92672>?</span> <span style=color:#66d9ef>true</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>SQLException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 异常日志打印及处理...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            reentrantLock<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>   <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 库存扣减（伪代码 synchronized )
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param stockRequestDTO
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Boolean
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> Boolean <span style=color:#a6e22e>stockHandle</span><span style=color:#f92672>(</span>StockRequestDTO stockRequestDTO<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行业务逻辑...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 库存扣减（伪代码 Semaphore )
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param stockRequestDTO
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Boolean
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Boolean <span style=color:#a6e22e>stockHandle</span><span style=color:#f92672>(</span>StockRequestDTO stockRequestDTO<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          semaphore<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 执行业务逻辑...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          semaphore<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果你的项目是单实例部署，那么使用以上锁或并发工具中的一种，都可以有效的防止超卖出现。</p><h2 id=分布式环境>分布式环境</h2><p>但现在的互联网公司，基本都是负载均衡的方式，访问集群中多个实例的，所以基于JVM级别的锁无法发挥作用，需要引入第三方组件来解决，分布式锁登场。</p><p>如果想实现分布式环境下的锁机制，最简单的莫过于利用MySQL的锁机制:
<img src=http://file-ok.hanyu.cool/hysite/hysite-tech/article/image/2021-03-23/db_lock.png alt=DBLOCK></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#f92672>***</span> <span style=color:#960050;background-color:#1e0010>使用悲观锁实现</span> <span style=color:#f92672>***</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>begin</span>; <span style=color:#75715e>-- 开启事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>select</span>  stock_num <span style=color:#66d9ef>from</span> t_stock t_stock <span style=color:#66d9ef>where</span> goodsId <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;12345&#39;</span> <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>update</span>; <span style=color:#75715e>-- 获取并设置排他锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>update</span> t_stock <span style=color:#66d9ef>set</span> stock_num <span style=color:#f92672>=</span> stock_num <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>  <span style=color:#66d9ef>where</span> goodsId <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;12345&#39;</span> <span style=color:#960050;background-color:#1e0010>；</span><span style=color:#75715e>-- 更新资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>commit</span>; <span style=color:#75715e>-- 提交事务并解锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>***</span> <span style=color:#960050;background-color:#1e0010>乐观锁实现</span> <span style=color:#f92672>***</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>update</span> t_stock <span style=color:#66d9ef>set</span> stock_num <span style=color:#f92672>=</span> stock_num <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> , <span style=color:#66d9ef>version</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>version</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>where</span> goodsId <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;12345&#39;</span> <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>version</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- 1.更新资源时先判断当前数据版本号和之前获取时是否一致
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- 2.如果版本号一致，更新资源并版本号+1
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- 3.若版本号不一致，返回错误并由业务系统进行自旋重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>***</span> <span style=color:#960050;background-color:#1e0010>唯一索引实现</span> <span style=color:#f92672>***</span> 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>较简单，此方式实际应用几乎没有，不再赘述</span>
</span></span></code></pre></div><p>有一点要注意，乐观锁的自旋是需要在自己的业务逻辑中实现的。</p><p>使用数据库作为分布式锁，优点是实现简单、不需要引入其他中间件，缺点是可能存在磁盘IO，性能一般。</p><p>那有没有性能够用、实现简单、且在分布式环境下能保证资源并发安全的方案呢？常规有三，Redis、Zookeeper、MQ，其中MQ的解决方案不能算分布式锁。<br>今天我们介绍第一种，使用Redis实现分布式锁，Redis分布式锁的特点是轻松保证可重入、互斥。<br>Redis中提供了SetNX+Expire两个命令，可以对指定的Key加锁：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// redis原生命令
</span></span><span style=display:flex><span>redis-cli 127.0.0.1:6379&gt; SETNX KEY_NAME VALUE
</span></span><span style=display:flex><span>redis-cli 127.0.0.1:6379&gt; EXPlRE &lt;key&gt; &lt;ttl&gt; 
</span></span></code></pre></div><p>spring-boot-starter-data-redis 也提供了操作Redis的模板类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>     <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 库存扣减 (伪代码 spring-boot-starter-data-redis中提供的模板方法)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param stockRequestDTO
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Boolean
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span><span style=color:#f92672>(</span>rollbackFor <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>RuntimeException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Error<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Boolean <span style=color:#a6e22e>stockHandle</span><span style=color:#f92672>(</span>StockRequestDTO stockRequestDTO<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 省略日志打印...校验...前置处理等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Boolean redisLock <span style=color:#f92672>=</span> redisTemplate
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>setIfAbsent</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>redisLock<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span><span style=color:#f92672>((</span>stockLockKey<span style=color:#f92672>,</span>1<span style=color:#f92672>,</span>TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                Object stock <span style=color:#f92672>=</span> redisTemplate
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>stockKeyPrefix<span style=color:#f92672>.</span><span style=color:#a6e22e>concat</span><span style=color:#f92672>(</span>stockRequestDTO<span style=color:#f92672>.</span><span style=color:#a6e22e>getGoodsId</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> stock <span style=color:#f92672>||</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>stock<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>())</span> <span style=color:#f92672>&lt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 库存异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 扣减库存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    stock <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>stock<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>())</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 更新数据库、缓存等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 释放锁等等后置处理...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>原子性问题</p></blockquote><p>以上代码存在一个问题，假设</p><ul><li>1.）A线程获取锁成功</li><li>2.）A线程所在实例挂掉了</li><li>3.）A线程还没来得及给锁设置过期时间，Redis中资源会被永久锁住</li></ul><p>所以我们需要使用原子指令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// redis原生命令
</span></span><span style=display:flex><span>redis-cli 127.0.0.1:6379&gt; set key value <span style=color:#f92672>[</span>EX seconds<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>PX milliseconds<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>NX|XX<span style=color:#f92672>]</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 方式一：省略其他代码......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>boolean</span> redisLock <span style=color:#f92672>=</span> redisTemplate
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setIfAbsent</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>,</span><span style=color:#66d9ef>true</span><span style=color:#f92672>,</span>30<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>// 方式二：使用Lua脚本进行加锁保证原子性（伪代码）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        StringBuilder sb <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;if redis.call(\&#34;setnx\&#34;, KEYS[1], KEYS[2]) == 1 then&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;return redis.call(\&#34;pexpire\&#34;, KEYS[1], KEYS[3])&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;else&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;return 0&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        LUA_SCRIPT <span style=color:#f92672>=</span> sb<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long <span style=color:#a6e22e>redisLockByLua</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> num<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 脚本里的KEYS参数，忽略类型转换等......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> keys <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        keys<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        keys<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        keys<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>30<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>long</span><span style=color:#f92672>)</span> redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> DefaultRedisScript<span style=color:#f92672>(</span>LUA_SCRIPT<span style=color:#f92672>),</span> keys<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>超时&误删锁问题</p></blockquote><p>虽然我们优化了，但还是有BUG，假设现在A 和 B 两个线程同时访问以上代码：</p><ul><li>1.）A先获得锁</li><li>2.）A执行扣减库存过程中因为不可控的原因超过了设定的10秒，此时分布式锁失效</li><li>3.）B线程将竞争获得锁开始执行任务</li><li>4.）此时A和B并行对加锁资源操作，可能造成错误</li><li>5.）A执行比B执行任务快，A恰好执行到最后一步删除锁</li><li>6.）B的任务还在执行，B的锁却被A删除，C线程也将竞争到锁，与B同时并行执行，循环往复，业务语义发生错误，可能导致各种脏数据产生</li></ul><p>这种现象还是比较容易发生的，对于锁超时问题，我们加以优化：</p><ul><li>1.）假如锁的超时时间是10秒</li><li>2.）获取锁后使用ScheduledExecutorService开启守护线程</li><li>3.）守护线程每隔5秒去查看分布式锁是否还存在，如果存在就进行续期10秒</li></ul><p>对于误删锁的问题，我们也可以加强优化一下：</p><ul><li>1.）A线程获取到锁之前先生成一个随机串</li><li>2.）A线程将锁的value设置为该随机串</li><li>3.）A线程删除锁时先判断锁的value是否为A线程刚才随机生成的随机串</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 库存扣减 (伪代码 spring-boot-starter-data-redis中提供的模板方法)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param stockRequestDTO
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Boolean
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Transactional</span><span style=color:#f92672>(</span>rollbackFor <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>RuntimeException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Error<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Boolean <span style=color:#a6e22e>stockHandle</span><span style=color:#f92672>(</span>StockRequestDTO stockRequestDTO<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 省略日志打印...校验...前置处理等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String nonceStr <span style=color:#f92672>=</span> UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        ScheduledExecutorService scheduledExecutorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newScheduledThreadPool</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//竞争锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>boolean</span> redisLock <span style=color:#f92672>=</span> redisTemplate
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>setIfAbsent</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> 30<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>redisLock<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 开启守护线程定时对锁续命
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                scheduledExecutorService<span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleWithFixedDelay</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>hasKey</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>expire</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>,</span> 30<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>},</span> 15<span style=color:#f92672>,</span> 15<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 获取库存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                String stockKey <span style=color:#f92672>=</span>  stockKeyPrefix<span style=color:#f92672>.</span><span style=color:#a6e22e>concat</span><span style=color:#f92672>(</span>stockRequestDTO<span style=color:#f92672>.</span><span style=color:#a6e22e>getGoodsId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                Object stock <span style=color:#f92672>=</span> redisTemplate
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>stockKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> stock <span style=color:#f92672>||</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>stock<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>())</span> <span style=color:#f92672>&lt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 库存异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 扣减库存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>stockKey<span style=color:#f92672>,</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>stock<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>())</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 更新数据库等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 释放锁等等后置处理... 也可使用lua脚本保证原子性判断和删除锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>).</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>nonceStr<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>delete</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            scheduledExecutorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdownNow</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>释放锁也需要原子性执行，我们依然使用Lua脚本来保证原子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>// 解锁 (伪代码)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        StringBuilder sb <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;if redis.call(\&#34;get\&#34;,KEYS[1]) == KEYS[2] then&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;return redis.call(\&#34;del\&#34;,KEYS[1])&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;else&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;return -1&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        LUA_SCRIPT <span style=color:#f92672>=</span> sb<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long <span style=color:#a6e22e>redisUnlockByLua</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> num<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 脚本里的KEYS参数，忽略类型转换等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        List<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> keys <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        keys<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>stockLockKey<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        keys<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;线程加锁时生成的随机数&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>long</span><span style=color:#f92672>)</span> redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> DefaultRedisScript<span style=color:#f92672>(</span>LUA_SCRIPT<span style=color:#f92672>),</span> keys<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>Redisson</p></blockquote><p>对于锁超时问题，我们还可以使用现成的工具Redisson，Redisson提供了WatchDog（看门狗）机制，内置了锁续命机制，无需手动实现。
<img src=http://file-ok.hanyu.cool/hysite/hysite-tech/article/image/2021-03-23/redisson.png alt=DBLOCK></p><p>注意，要想使用开门狗机制Redisson加锁时不要指定超时时间，默认锁超时时间30秒，看门狗每隔30秒的1/3时间也就是10秒去检查一次锁状态，锁还在就进行续命。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 构造Redisson Config
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Config config <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Config<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>config<span style=color:#f92672>.</span><span style=color:#a6e22e>useClusterServers</span><span style=color:#f92672>().</span><span style=color:#a6e22e>addNodeAddress</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;redis://ip1:port1&#34;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#34;redis://ip2:port2&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;redis://ip3:port3&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;redis://ip4:port4&#34;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#34;redis://ip5:port5&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;redis://ip6:port6&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>setPassword</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;a123456&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setScanInterval</span><span style=color:#f92672>(</span>5000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 构造RedissonClient
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>RedissonClient redissonClient <span style=color:#f92672>=</span> Redisson<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 设置锁定资源名称
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>RLock rLock <span style=color:#f92672>=</span> redissonClient<span style=color:#f92672>.</span><span style=color:#a6e22e>getLock</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;lock_key&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// boolean isLock;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 尝试获取分布式锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// isLock = rLock.tryLock(500, 15000, TimeUnit.MILLISECONDS);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rLock<span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 日志...业务处理等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 日志等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    rLock<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>主从数据一致性问题</p></blockquote><p>不过此时还可能出现一种意外情况，假设Redis主从环境：</p><ul><li><p>1.）A线程在Redis Master节点获得了锁，还没同步给Slave</p></li><li><p>2.）Master节点挂掉</p></li><li><p>3.）故障转移后Slave节点升级为Master节点</p></li><li><p>4.）此时B线程将竞争到锁，至此A和B同时对加锁任务并行执行，业务语义发生错误，可能导致各种脏数据产生</p><p>要解决这个问题，可以使用Redis官方提供的RedLock算法。<br>简单来说RedLock 的思想是使用多台Redis Master，节点完全独立，节点间不需要进行数据同步。<br>假设N个节点，在有效时间内当获得锁的数量大于 (N/2+1) 代表成功，失败后需要向所有节点发送释放锁的消息。<br>RedLock的方式也有缺点，因为需要对多个节点操作加锁解锁，高并发情况下，耗时较长响应延迟，对性能有影响。<br>后面我们找个时间专门讲一下RedLock源码以及存在的问题。</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Config config1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Config<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>config1<span style=color:#f92672>.</span><span style=color:#a6e22e>useSingleServer</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setAddress</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;redis://ip1:port1&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setPassword</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;...&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setDatabase</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>RedissonClient redissonClient1 <span style=color:#f92672>=</span> Redisson<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>config1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Config config2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Config<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>config2<span style=color:#f92672>.</span><span style=color:#a6e22e>useSingleServer</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setAddress</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;redis://ip2:port2&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setPassword</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;...&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setDatabase</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>RedissonClient redissonClient2 <span style=color:#f92672>=</span> Redisson<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>config2<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Config config3 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Config<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>config3<span style=color:#f92672>.</span><span style=color:#a6e22e>useSingleServer</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setAddress</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;redis://ip3:port3&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setPassword</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;...&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setDatabase</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>RedissonClient redissonClient3 <span style=color:#f92672>=</span> Redisson<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>config3<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>String lockKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lock_key&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>RedissonRedLock redLock <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RedissonRedLock<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                redissonClient1<span style=color:#f92672>.</span><span style=color:#a6e22e>getLock</span><span style=color:#f92672>(</span>lockKey<span style=color:#f92672>),</span> 
</span></span><span style=display:flex><span>                redissonClient2<span style=color:#f92672>.</span><span style=color:#a6e22e>getLock</span><span style=color:#f92672>(</span>lockKey<span style=color:#f92672>),</span> 
</span></span><span style=display:flex><span>                redissonClient3<span style=color:#f92672>.</span><span style=color:#a6e22e>getLock</span><span style=color:#f92672>(</span>lockKey<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// boolean isLock;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 尝试获取分布式锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// isLock = redLock.tryLock(500, 15000, TimeUnit.MILLISECONDS);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    redLock<span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 日志...业务处理等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 日志等...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    redLock<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>事务问题</p></blockquote><p>至此，是不是万无一失了呢？其实还没完，还有一个隐藏问题。<br>我们知道，MySQL默认的事务隔离级别是Repeatable-Read可重复读。<br><img src=http://file-ok.hanyu.cool/hysite/hysite-tech/article/image/2021-03-23/mysql_t.png alt=DBLOCK></p><p>通过上述表格可以看出，Repeatable-Read这种隔离级别在同一个事务中多次读取的数据是一致的；<br>另一方面，Spring声明式事务默认的传播特性是Required，在调用声明式事务修饰的方法stockHandle之前就已经开启了事务；</p><p>以上两点会导致：</p><ul><li><p>1.）线程Thread-A和Thread-B都执行到该方法</p></li><li><p>2.）各自开启了事务Transation-A和Transation-B</p></li><li><p>3.）Transation-A先执行加锁、执行、解锁</p></li><li><p>4.）Transation-B后执行加锁、执行、解锁</p></li><li><p>5.）由于Transation-B事务的开启，是在Transation-A事务提交之前</p></li><li><p>6.）此时默认隔离级别Repeatable-Read，事务Transation-B事务读取不到Transation-A已经提交的数据</p></li><li><p>7.）就会出现Transation-A和Transation-B事务开启后读取到的值是一样的，即Transation-B读取的是Transation-A更新前的数据</p><p>要解决这种隐藏BUG，可以将库存信息放入Redis，利用Redis的decr方法在分布式环境下原子性的扣减库存：</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#75715e>// 省略其他代码
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Redis原子扣减库存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   Long stock <span style=color:#f92672>=</span> redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>decrement</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> stock <span style=color:#f92672>||</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>stock<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>())</span> <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 库存异常
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 更新数据库等...
</span></span></span></code></pre></div><p>至于MQ和Zookeeper方式今天不在此介绍啦，大家感兴趣的话我后面专门开篇来讲。<br>其实没有最完美无缺的方案，以上方案还是会存在某些特定场景下的特定问题，具体场景具体分析，逐步优化，一步步思考，加固项目城墙之余，也夯实自身的技术壁垒。</p></div></div><div id=post-action class="post-action mt-3 mt-lg-5"><div class=hr-short></div><div class="post-declare mt-3 mt-md-4"><p>本文是作者
<a href=# title=韩西瓜 rel=author>「韩西瓜」</a>的胡思乱想，版权归全世界所有，你随便抄</p></div><div class="d-flex flex-fill align-items-center"><div class=flex-md-fill></div><div id=scrollshare class=post-social><a href="javascript: alert('Sorry ~ 分享功能在开发中哦')" class="btn btn-light btn-icon btn-weibo btn-rounded btn-md m-1"><span><i class="iconfont icon-weibo"></i></span></a>
<a href="javascript: alert('Sorry ~ 分享功能在开发中哦')" class1="btn btn-light btn-icon btn-weixin single-popup btn-rounded btn-md m-1" class="btn btn-light btn-icon btn-weixin btn-rounded btn-md m-1" data-img data-title="微信扫一扫 分享朋友圈" data-desc=在微信内长按二维码><span><i class="iconfont icon-weixin1"></i></span></a>
<a href="javascript: alert('Sorry ~ 分享功能在开发中哦')" class="btn btn-light btn-icon btn-qq btn-rounded btn-md m-1"><span><i class="iconfont icon-qq"></i></span></a></div></div></div><div class="post-next-prev list-grouped row-sm my-n1 pt-5"><div class="col-12 col-md-6 py-1"><div class="list-item list-overlay block custom-hover overlay-hover"><div class="media media-3x1"><div class=media-content style=background-image:url(https://okhanyu.oss-cn-beijing.aliyuncs.com/hysite/hysite-fun/artice/image/test/1.jpg) data-nclazyload=true><div class=overlay-1></div></div></div><a href=/lifeblog/posts/section-top-left/top-banner-left/ class="list-content p-3" title=我是大banner><div class=list-body><div class=list-title><div class="h-2x h6 text-white">我是大banner</div></div></div><div class=list-footer><div class="d-flex align-items-center flex-fill"><div class="text-xs text-muted">上一篇</div><div class=flex-fill></div><i class="text-md iconfont icon-xianghou"></i></div></div></a></div></div></div></div></div></div></div></main><div class="list-related list-scroll bg-light py-4 py-lg-5"><div class=container><div class="h5 mb-3 mb-md-4"><i class="text-xl text-primary iconfont icon-gengxin mr-1"></i>
<span class="d-inline-block align-middle">相关文章</span></div><div class=list-scroll-x><div class="row row-md list-grouped list-bordered-padding"><div class="col-6 col-md-3 d-flex"><div class="list-item overlay-hover"><div class="media media-16x9"><a href=https://hanyu.cool/lifeblog/posts/section-card/tech/first%E7%9A%84%E5%89%AF%E6%9C%AC/ class=media-content style="background-image:url(https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=1336119765,2231343437&fm=26&gp=0.jpg)" data-nclazyload=true><div class=overlay></div></a></div><div class=list-content><div class=list-body><a href=https://hanyu.cool/lifeblog/posts/section-card/tech/first%E7%9A%84%E5%89%AF%E6%9C%AC/ title=我是一篇技术文章 class="list-title text-md h-2x">我是一篇技术文章</a></div></div></div></div><div class="col-6 col-md-3 d-flex"><div class="list-item overlay-hover"><div class="media media-16x9"><a href=https://hanyu.cool/lifeblog/posts/section-top-left/top-banner-left/ class=media-content style=background-image:url(https://okhanyu.oss-cn-beijing.aliyuncs.com/hysite/hysite-fun/artice/image/test/1.jpg) data-nclazyload=true><div class=overlay></div></a></div><div class=list-content><div class=list-body><a href=https://hanyu.cool/lifeblog/posts/section-top-left/top-banner-left/ title=我是大banner class="list-title text-md h-2x">我是大banner</a></div></div></div></div><div class="col-6 col-md-3 d-flex"><div class="list-item overlay-hover"><div class="media media-16x9"><a href=https://hanyu.cool/lifeblog/posts/section-list/life/top-banner-left/ class=media-content style=background-image:url(https://okhanyu.oss-cn-beijing.aliyuncs.com/hysite/hysite-fun/artice/image/test/1.jpg) data-nclazyload=true><div class=overlay></div></a></div><div class=list-content><div class=list-body><a href=https://hanyu.cool/lifeblog/posts/section-list/life/top-banner-left/ title=我是大banner class="list-title text-md h-2x">我是大banner</a></div></div></div></div><div class="col-6 col-md-3 d-flex"><div class="list-item overlay-hover"><div class="media media-16x9"><a href=https://hanyu.cool/lifeblog/posts/section-card/tech/first%E7%9A%84%E5%89%AF%E6%9C%AC2/ class=media-content style="background-image:url(https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=1336119765,2231343437&fm=26&gp=0.jpg)" data-nclazyload=true><div class=overlay></div></a></div><div class=list-content><div class=list-body><a href=https://hanyu.cool/lifeblog/posts/section-card/tech/first%E7%9A%84%E5%89%AF%E6%9C%AC2/ title=我是一篇技术文章 class="list-title text-md h-2x">我是一篇技术文章</a></div></div></div></div></div></div></div></div></div><footer class="footer bg-dark"><div class=container><div class="row py-3 py-lg-4"><div class="col-lg-6 pr-lg-5 py-3"><div class="footer-widget pr-lg-5"><div class="footer-widget-header mb-2 mb-md-3"><span>关于</span></div><div class=footer-widget-content><p>我是韩西瓜，全世界走走逛逛拍拍玩玩。</p></div><div class="footer-widget-social mx-n2 mt-3"><a href=https://weibo.com/sohanyu target=_blank class="weibo btn btn btn-secondary btn-icon btn-rounded m-1"><span><i class="iconfont icon-weibo1"></i></span></a>
<a href=https://github.com/okhanyu target=_blank class="btn btn-secondary btn-icon btn-rounded m-1"><span><i class="iconfont icon-github"></i></span></a></div></div></div><div class="col-lg-3 py-3"><div class=footer-widget><div class="footer-widget-header mb-2 mb-md-3"><span>社交媒体</span></div><div class=footer-widget-content><div class=footer-widget-links><a href=https://weibo.com/sohanyu target=_blank>微博</a></div></div></div></div><div class="col-lg-3 py-3"><div class=footer-widget><div class="footer-widget-header mb-2 mb-md-3"><span>友情链接</span></div><div class=footer-widget-content><div class=footer-widget-links><a href=https://hanyu.cool>韩西瓜的电台</a></div></div></div></div></div></div><div class="footer-copyright text-xs border-top border-secondary py-3 py-md-4"><div class=container>Copyright © 2020-2020
<a href=https://hanyu.cool/ title=韩西瓜 rel=home>韩西瓜</a></div></div></footer><html><head></head><body><div class=mobile-overlay></div><aside class="mobile-sidebar bg-light"><div class=mobile-sidebar-inner><div class=mobile-sidebar-action><a href=javascript:; class="link-action switch-dark-mode text-xl text-muted mr-2"><i class="night iconfont icon-moon_circle"></i><i class="light text-warning iconfont icon-moon_circle_fill"></i></a><button type=button class="link-action text-xl text-muted" id=mobile-sidebar-close>
<i class="d-block iconfont icon-close-filled"></i></button></div><div class=mobile-sidebar-tab-menu><ul id=mobile-tab-menu-id class=mobile-tab-menu><li id=menu-item-5123 class="menu-item menu-item-type-custom menu-item-object-custom current-menu-ancestor current-menu-parent menu-item-has-children menu-item-5123"><a>推荐</a><ul class=sub-menu><li id=menu-item-5122 class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-5122"><a href=/ aria-current=page>首页</a></li></ul></li><li id=menu-item-4897 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-4897"><a>社交</a><ul class=sub-menu><li id=menu-item-4924 class="menu-item menu-item-type-post_type menu-item-object-post menu-item-4925"><a href=https://hanyu.cool/wechat/>公众号</a></li><li id=menu-item-5124 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5124"><a href=https://weibo.com/sohanyu>微博</a></li><li id=menu-item-5124 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5124"><a href="javascript: alert('Sorry ~ 正在筹建中啦')">播客</a></li></ul></li><li id=menu-item-4897 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-4897"><a>ABOUT</a><ul class=sub-menu><li id=menu-item-4925 class="menu-item menu-item-type-post_type menu-item-object-post menu-item-4925"><a href=https://hanyu.cool/about/>关于</a></li></ul></li></ul></div></div></aside><div class=nice-fixed-totop><a id=back-to-top href=javascript: class="btn btn-secondary btn-icon btn-lg current"><span class=icon-stack><i class="text-sm iconfont icon-caret-up"></i><small class=back-to-top-text>Top</small></span></a></div></body></html><script type=text/javascript src=https://file.hanyu.cool/site/life/static/v1/js/smartideo.js></script><script type=text/javascript src=https://file.hanyu.cool/site/life/static/v1/js/lazyload.min.js></script><script src=https://file.hanyu.cool/site/life/static/v1/js/popper.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js></script><script type=text/javascript src=https://file.hanyu.cool/site/life/static/v1/js/plugins.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js></script><script type=text/javascript src=https://file.hanyu.cool/site/life/static/v1/js/ResizeSensor.min.js></script><script type=text/javascript src=https://file.hanyu.cool/site/life/static/v1/js/theia-sticky-sidebar.min.js></script><script type=text/javascript src=https://file.hanyu.cool/site/life/static/v1/js/h.js></script><script src=https://file.hanyu.cool/site/life/static/v1/js/highlight.pack.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/picturefill/2.3.1/picturefill.min.js></script>
<script src=https://cdn.bootcdn.net/ajax/libs/jquery-mousewheel/3.1.8/jquery.mousewheel.min.js></script>
<script src=https://file.hanyu.cool/site/life/static/v1/js/lightgallery-all.min.js></script></body></html>